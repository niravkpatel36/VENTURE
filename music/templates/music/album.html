{% extends "music/layout.html" %}
{% load static %}

{% block body %}

<a href="{% url 'music:home_page' %}" class="home-btn">Home</a>

<style>
.home-btn {
    position: fixed;
    top: 22px;
    right: 26px;
    background: rgba(0,0,0,0.55);
    padding: 10px 18px;
    border-radius: 12px;
    color: white;
    text-decoration: none;
    font-size: 1rem;
    backdrop-filter: blur(6px);
    border: 1px solid rgba(255,255,255,0.15);
    transition: 0.25s ease;
    z-index: 999;
}
.home-btn:hover {
    background: rgba(255,255,255,0.20);
    transform: scale(1.06);
}
</style>


<style>
  /* A2 - Deep Space Apple style */
  :root{
    --bg:#040516;
    --card: rgba(255,255,255,0.03);
    --glass: rgba(255,255,255,0.04);
    --accent: linear-gradient(90deg,#7c3aed,#06b6d4);
    --muted: #9aa4b3;
    --soft-white: #e6eef8;
  }

  body.album-page { margin:0; background:var(--bg); color:var(--soft-white); font-family:"Poppins",sans-serif; min-height:100vh; }

  /* full-bleed blurred background behind content */
  .bg-blur {
    position:fixed;
    inset:0;
    z-index:0;
    background-size:cover;
    background-position:center;
    filter: blur(28px) brightness(.45);
    transform: scale(1.04);
  }

  .page-wrap {
    position:relative;
    z-index:2;
    max-width:1100px;
    margin:36px auto 80px;
    padding:18px;
  }

  .top-home { position: fixed; top: 18px; right: 22px; z-index:9999; }
  .top-home a{
    display:inline-block;
    color: #fff;
    text-decoration:none;
    background: rgba(0,0,0,0.36);
    padding: 8px 12px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.06);
    backdrop-filter: blur(6px);
    font-weight:600;
  }
  .top-home a:hover { background: rgba(255,255,255,0.06); }

  .hero {
    display:flex;
    gap:28px;
    align-items:center;
    padding:26px;
    border-radius:16px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    box-shadow: 0 30px 80px rgba(2,6,23,0.7);
    position:relative;
    overflow:visible;
  }

  .album-art {
    width:320px;
    height:320px;
    border-radius:20px;
    object-fit:cover;
    box-shadow: 0 40px 80px rgba(0,0,0,0.8), 0 8px 30px rgba(0,0,0,0.6);
    cursor: zoom-in;
    transition: transform .26s ease;
  }
  .album-art:hover { transform: scale(1.02); }

  .meta {
    color: var(--muted);
    margin-bottom:12px;
  }

  .title-main { font-size:1.9rem; margin:0; color:var(--soft-white); }
  .subtitle { color:var(--muted); margin-top:6px; }

  /* Master player - Apple style */
  .master-player {
    margin-top:18px;
    display:flex;
    flex-direction:column;
    gap:12px;
    align-items:center;
  }

  .now-title {
    font-weight:700;
    font-size:1.05rem;
    color: #fff;
    text-align:center;
  }

  .controls {
    display:flex;
    gap:18px;
    align-items:center;
    margin-top:6px;
  }

  .ctrl-btn {
    width:56px;
    height:56px;
    border-radius:14px;
    border:none;
    background: rgba(255,255,255,0.03);
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    box-shadow: 0 8px 20px rgba(2,6,23,0.6);
    transition: transform .12s ease, background .12s ease;
  }
  .ctrl-btn:active { transform: scale(.96); }
  .play-btn {
    width:70px;
    height:70px;
    border-radius:20px;
    background: var(--accent);
    display:flex;
    align-items:center;
    justify-content:center;
    color:white;
    font-weight:800;
    font-size:20px;
    box-shadow: 0 12px 30px rgba(124,58,237,0.12);
  }

  /* Track list */
  .track-list {
    margin-top:22px;
    border-radius:12px;
    overflow:hidden;
    background: rgba(255,255,255,0.01);
    padding: 8px;
  }

  .track-row {
    display:flex;
    gap:14px;
    align-items:center;
    padding:12px 14px;
    border-bottom: 1px solid rgba(255,255,255,0.02);
    cursor:pointer;
    transition: background .12s ease;
  }
  .track-row:hover { background: rgba(255,255,255,0.02); }
  .track-row.playing { background: linear-gradient(90deg, rgba(124,58,237,0.08), rgba(6,182,212,0.04)); }

  .index { width:46px; color:var(--muted); text-align:center; }
  .track-title { flex:1; font-weight:600; color:#fff; }
  .track-duration { width:72px; color:var(--muted); text-align:right; font-size:0.95rem; }

  /* Modal (enlarged album art) */
  .modal {
    position:fixed;
    inset:0;
    z-index:99999;
    display:none;
    align-items:center;
    justify-content:center;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(6px);
  }
  .modal.open { display:flex; }
  .modal-inner {
    max-width:820px;
    width:92%;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    padding:24px;
    border-radius:20px;
    display:flex;
    gap:18px;
    align-items:center;
  }
  .modal-art {
    width:420px; height:420px; border-radius:18px; object-fit:cover; box-shadow: 0 40px 120px rgba(0,0,0,0.85);
  }
  .modal-info { color:var(--soft-white); }
  .modal-close {
    position:absolute; top:20px; right:20px; font-size:24px; color:white; cursor:pointer;
  }

  @media (max-width: 920px) {
    .hero { flex-direction:column; align-items:center; padding:18px; }
    .album-art { width:240px; height:240px; }
    .modal-art { width:320px; height:320px; }
  }
</style>

<!-- top-right Home -->
<div class="top-home"><a href="{% url 'music:home_page' %}">Home</a></div>

{% if album_art %}
  <div class="bg-blur" style="background-image: url('{{ album_art }}');"></div>
{% else %}
  <div class="bg-blur" style="background: linear-gradient(135deg,#0b122b,#061426);"></div>
{% endif %}

<div class="page-wrap">
  <div class="hero">
    <img id="coverArt" class="album-art" src="{{ album_art }}" alt="Album cover">

    <div style="flex:1;">
      <h2 class="title-main">{{ album_title }}</h2>
      <div class="meta">by N1RAV</div>

      <div class="master-player" aria-live="polite">
        <div class="now-title" id="nowTitle">—</div>
        <div class="controls" role="group" aria-label="Player controls">
          <button id="prevBtn" class="ctrl-btn" title="Previous" aria-label="Previous">◀</button>
          <button id="playPauseBtn" class="play-btn" title="Play/Pause" aria-label="Play/Pause">▶</button>
          <button id="nextBtn" class="ctrl-btn" title="Next" aria-label="Next">▶</button>
        </div>
      </div>
    </div>
  </div>

  <div class="track-list" id="trackList">
    {% for t in album_tracks %}
      <div class="track-row" data-src="{{ t.file }}" data-title="{{ t.title }}">
        <div class="index">{{ forloop.counter }}</div>
        <div class="track-title">{{ t.title }}</div>
        <div class="track-duration" data-duration="">—:—</div>
      </div>
    {% endfor %}
  </div>
</div>

<!-- Modal for enlarged art -->
<div id="artModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-inner">
    <img id="modalArt" class="modal-art" src="{{ album_art }}" alt="Album cover enlarged">
    <div class="modal-info">
      <div style="font-weight:800; font-size:1.3rem;">{{ album_title }}</div>
      <div style="margin-top:12px;color:var(--muted);">by N1RAV</div>

      <div style="margin-top:20px;">
        <div class="now-title" id="modalNow">—</div>
        <div style="margin-top:12px; display:flex; gap:12px; align-items:center;">
          <button id="modalPrev" class="ctrl-btn">◀</button>
          <button id="modalPlay" class="play-btn">▶</button>
          <button id="modalNext" class="ctrl-btn">▶</button>
        </div>
      </div>
    </div>
  </div>
  <div id="modalClose" class="modal-close">✕</div>
</div>

<script>
/* Master playlist & player logic — uses your album_tracks context entries */
(function(){
  // gather track rows
  const rows = Array.from(document.querySelectorAll('.track-row'));
  if (!rows.length) return;

  const playlist = rows.map(r => ({ src: r.dataset.src, title: r.dataset.title }));
  const audio = document.createElement('audio');
  audio.preload = 'auto';
  audio.crossOrigin = 'anonymous';
  document.body.appendChild(audio);

  // DOM refs
  const nowTitle = document.getElementById('nowTitle');
  const playPauseBtn = document.getElementById('playPauseBtn');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');

  const modal = document.getElementById('artModal');
  const modalClose = document.getElementById('modalClose');
  const modalPlay = document.getElementById('modalPlay');
  const modalPrev = document.getElementById('modalPrev');
  const modalNext = document.getElementById('modalNext');
  const modalNow = document.getElementById('modalNow');
  const coverArt = document.getElementById('coverArt');
  const modalArt = document.getElementById('modalArt');

  let idx = 0;
  let isPlaying = false;

  // format seconds -> M:SS
  function fmt(t) {
    if (!t || isNaN(t)) return '—:—';
    const m = Math.floor(t/60);
    const s = Math.round(t % 60).toString().padStart(2,'0');
    return `${m}:${s}`;
  }

  // populate durations by loading metadata (lightweight)
  rows.forEach((r, i) => {
    const durEl = r.querySelector('.track-duration');
    const tmp = new Audio();
    tmp.src = r.dataset.src;
    tmp.preload = 'metadata';
    tmp.addEventListener('loadedmetadata', () => {
      durEl.textContent = fmt(tmp.duration);
      durEl.dataset.duration = tmp.duration;
    });
    tmp.addEventListener('error', () => {
      durEl.textContent = '—:—';
    });
  });

  function highlight() {
    rows.forEach((r,j) => r.classList.toggle('playing', j === idx));
  }

  function setTrack(i, autoPlay = false) {
    idx = (i + playlist.length) % playlist.length;
    audio.src = playlist[idx].src;
    nowTitle.textContent = playlist[idx].title;
    modalNow.textContent = playlist[idx].title;
    highlight();
    if (autoPlay) { audio.play().catch(()=>{}); isPlaying = true; updatePlayBtn(); }
  }

  function updatePlayBtn() {
    playPauseBtn.textContent = audio.paused ? '▶' : '⏸';
    modalPlay.textContent = audio.paused ? '▶' : '⏸';
  }

  // initial
  setTrack(0, false);

  // controls
  playPauseBtn.addEventListener('click', ()=>{
    if (!audio.src) setTrack(0, true);
    if (audio.paused) { audio.play(); isPlaying = true; } else { audio.pause(); isPlaying = false; }
    updatePlayBtn();
  });

  prevBtn.addEventListener('click', ()=>{ setTrack(idx-1, true); updatePlayBtn(); });
  nextBtn.addEventListener('click', ()=>{ setTrack(idx+1, true); updatePlayBtn(); });

  // rows clickable
  rows.forEach((r,i) => {
    r.addEventListener('click', () => {
      setTrack(i, true);
      updatePlayBtn();
    });
  });

  // auto-next when ended
  audio.addEventListener('ended', ()=> {
    setTrack(idx+1, true);
    updatePlayBtn();
  });

  // sync play/pause state when user uses native keyboard or other controls
  audio.addEventListener('play', ()=> { isPlaying = true; updatePlayBtn(); });
  audio.addEventListener('pause', ()=> { isPlaying = false; updatePlayBtn(); });

  // cover click -> modal open
  coverArt.addEventListener('click', ()=> {
    modal.classList.add('open');
    modal.setAttribute('aria-hidden', 'false');
    // show correct image (in case changed)
    modalArt.src = coverArt.src;
  });

  modalClose.addEventListener('click', ()=> {
    modal.classList.remove('open');
    modal.setAttribute('aria-hidden', 'true');
  });

  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden', 'true');
    }
  });

  modalPlay.addEventListener('click', ()=> {
    if (audio.paused) audio.play(); else audio.pause();
  });
  modalPrev.addEventListener('click', ()=> { setTrack(idx-1, true); });
  modalNext.addEventListener('click', ()=> { setTrack(idx+1, true); });

  // keyboard support: space toggles play/pause, left/right for prev/next
  document.addEventListener('keydown', (e) => {
    if (e.code === 'Space') { e.preventDefault(); if (audio.paused) audio.play(); else audio.pause(); }
    if (e.code === 'ArrowLeft') setTrack(idx-1, true);
    if (e.code === 'ArrowRight') setTrack(idx+1, true);
    if (e.key === 'Escape') { modal.classList.remove('open'); modal.setAttribute('aria-hidden', 'true'); }
  });
})();
</script>

{% endblock %}


